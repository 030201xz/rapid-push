# 架构设计

设计方案：分层架构 + 管道模式

## 核心设计理念

- 工具层只做胶水 - MCP Tool 只负责调用编排器
- 管道式处理 - Input → 解析 → 转换 → 渲染 → 写入
- 单一职责模块 - 每个文件只做一件事
- 中间表示层 (IR) - 将输入解析为内部模型，后续处理基于 IR

## 目录结构

```
ddd-use-case-generator/
├── index.ts                    # MCP 工具入口（极简，<50行）
├── types/
│   ├── input.schema.ts         # 输入 Schema 定义
│   ├── output.schema.ts        # 输出 Schema 定义
│   └── index.ts                # 类型导出
│
├── core/
│   ├── orchestrator.ts         # 编排器：协调整个生成流程
│   ├── ir.ts                   # 中间表示层：内部数据模型
│   └── index.ts
│
├── parser/
│   ├── input-parser.ts         # 将原始输入解析为 IR
│   └── index.ts
│
├── renderer/
│   ├── schema-renderer.ts      # 渲染 input/output.schema.ts
│   ├── index-renderer.ts       # 渲染 index.ts
│   ├── command-renderer.ts     # 渲染 {name}.command.ts
│   ├── query-renderer.ts       # 渲染 {name}.query.ts
│   ├── handler-renderer.ts     # 渲染 {name}.handler.ts
│   └── index.ts
│
├── writer/
│   ├── file-writer.ts          # 文件写入（含目录创建）
│   ├── formatter.ts            # Prettier 格式化
│   └── index.ts
│
├── utils/
│   ├── naming.ts               # 命名转换（kebab→camel等）
│   ├── zod-migrator.ts         # Zod v4 API 迁移
│   └── index.ts
│
└── test.ts                     # 测试脚本
```

## 生成的文件结构

```
└── 📁{aggregate}
    └── 📁mutations
        └── 📁{operation-name}
            ├── index.ts              # 统一导出
            ├── input.schema.ts       # 输入 DTO
            ├── output.schema.ts      # 输出 DTO
            ├── {name}.command.ts     # Command 类
            ├── {name}.handler.ts     # Handler 类
        ├── index.ts                  # mutations 聚合导出
    └── 📁queries
        └── 📁{operation-name}
            ├── index.ts
            ├── input.schema.ts
            ├── output.schema.ts
            ├── {name}.query.ts       # Query 类
            ├── {name}.handler.ts     # Handler 类
        ├── index.ts                  # queries 聚合导出
    ├── index.ts                      # 聚合总导出
```

## 数据流图

```
┌─────────────────────────────────────────────────────────────────┐
│                         MCP Tool (index.ts)                     │
│                    接收输入，调用 Orchestrator                    │
└─────────────────────────────────┬───────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Orchestrator (编排器)                       │
│              协调 Parser → Renderer → Writer                     │
└─────────────────────────────────┬───────────────────────────────┘
                                  │
        ┌─────────────────────────┼─────────────────────────┐
        │                         │                         │
        ▼                         ▼                         ▼
┌───────────────┐        ┌───────────────┐        ┌───────────────┐
│    Parser     │        │   Renderer    │        │    Writer     │
│  输入 → IR    │   →    │   IR → 代码   │   →    │  代码 → 文件  │
└───────────────┘        └───────────────┘        └───────────────┘
                                │
                    ┌───────────┼───────────┐
                    │           │           │
                    ▼           ▼           ▼
              ┌─────────┐ ┌─────────┐ ┌─────────┐
              │ Schema  │ │ Command │ │ Handler │
              │Renderer │ │/Query   │ │Renderer │
              └─────────┘ │Renderer │ └─────────┘
                          └─────────┘
```

## 输入 Schema

```typescript
{
  basePath: string;           // 生成目录
  aggregateName?: string;     // 聚合名称（用于推断依赖）
  operations: [{
    type: 'query' | 'mutation';
    name: string;             // kebab-case
    description?: string;
    input: FieldDef[] | RefDef;
    output: FieldDef[] | RefDef;
    generateHandler?: boolean; // 默认 true
    handler?: {
      dependencies?: [{
        name: string;         // 参数名
        type: string;         // 类型名
        importPath: string;   // 导入路径
      }];
      imports?: string[];     // 额外 import
    };
  }];
}
```
