# Expo Updates v1 åè®®å¢å¼ºåŠŸèƒ½

æœ¬æ¬¡æ›´æ–°å®ç°äº†ä¸‰é¡¹å…³é”®åŠŸèƒ½ï¼Œä½¿æœåŠ¡ç«¯å®Œå…¨ç¬¦åˆ Expo Updates v1 åè®®è§„èŒƒã€‚

## 1. ğŸ—œï¸ Content-Encoding æ”¯æŒï¼ˆgzip å‹ç¼©ï¼‰

### åŠŸèƒ½è¯´æ˜

èµ„æºä¸‹è½½æ¥å£ `GET /assets/:hash` ç°åœ¨æ”¯æŒ gzip å‹ç¼©ï¼Œè‡ªåŠ¨æ ¹æ®å®¢æˆ·ç«¯çš„ `Accept-Encoding` å¤´è¿”å›å‹ç¼©å†…å®¹ã€‚

### æŠ€æœ¯å®ç°

- **è‡ªåŠ¨æ£€æµ‹**: è§£æ `Accept-Encoding` å¤´ï¼Œä¼˜å…ˆæ”¯æŒ gzip
- **é«˜æ€§èƒ½å‹ç¼©**: ä½¿ç”¨ Bun å†…ç½®çš„ `Bun.gzipSync()` API
- **æ™ºèƒ½é™çº§**: å‹ç¼©å¤±è´¥æ—¶è‡ªåŠ¨è¿”å›åŸå§‹æ•°æ®
- **æ­£ç¡®çš„å“åº”å¤´**:
  - `Content-Encoding: gzip`
  - `Vary: Accept-Encoding`
  - `Content-Length: <compressed_size>`

### ä½¿ç”¨ç¤ºä¾‹

```bash
# ä¸å‹ç¼©
curl http://localhost:6688/assets/abc123...

# Gzip å‹ç¼©
curl -H "Accept-Encoding: gzip" http://localhost:6688/assets/abc123...
```

### æ€§èƒ½æå‡

- JavaScript bundle: å‹ç¼©ç‡çº¦ 70-80%
- å›¾ç‰‡èµ„æº: æ ¹æ®æ ¼å¼æœ‰ä¸åŒå‹ç¼©æ•ˆæœ
- å­—ä½“æ–‡ä»¶: å‹ç¼©ç‡çº¦ 50-60%

### æ³¨æ„äº‹é¡¹

- âš ï¸ Brotli æ”¯æŒéœ€è¦ç¬¬ä¸‰æ–¹åº“ï¼Œå½“å‰ä»…å®ç° gzip
- âš ï¸ å·²å‹ç¼©çš„èµ„æºï¼ˆå¦‚ .png, .jpgï¼‰å‹ç¼©å¢ç›Šæœ‰é™

---

## 2. ğŸ¯ expo-manifest-filters ä¸šåŠ¡é€»è¾‘

### åŠŸèƒ½è¯´æ˜

æ ¹æ® Expo Updates v1 åè®®ï¼Œå®ç°äº†å®Œæ•´çš„ manifest filters æœºåˆ¶ï¼Œå…è®¸å®¢æˆ·ç«¯æŒ‰å…ƒæ•°æ®è¿‡æ»¤æ›´æ–°ã€‚

### æ¶æ„è®¾è®¡

#### æ•°æ®åº“æ‰©å±•

åœ¨ `channels` è¡¨æ–°å¢å­—æ®µï¼š

```typescript
manifestFilterKeys: string[] // æŒ‡å®šå“ªäº› metadata é”®ä½œä¸ºè¿‡æ»¤å™¨
```

#### å·¥å…·æ¨¡å—

åˆ›å»º `common/utils/sfv.ts`:

- `toSfvDictionary()`: å°†å¯¹è±¡è½¬æ¢ä¸º SFV å­—å…¸æ ¼å¼
- `fromSfvDictionary()`: ä» SFV å­—ç¬¦ä¸²è§£æä¸ºå¯¹è±¡
- `generateManifestFilters()`: æ ¹æ®å…ƒæ•°æ®ç”Ÿæˆè¿‡æ»¤å™¨

#### æœåŠ¡å±‚é›†æˆ

åœ¨ `manifest/service.ts` ä¸­:

1. è·å–æ¸ é“çš„ `manifestFilterKeys` é…ç½®
2. ä»æ›´æ–°çš„ `metadata` ä¸­æå–ç›¸åº”çš„å­—æ®µ
3. ç”Ÿæˆ SFV æ ¼å¼çš„è¿‡æ»¤å™¨å­—ç¬¦ä¸²
4. åœ¨ router ä¸­è®¾ç½® `expo-manifest-filters` å“åº”å¤´

### é…ç½®ç¤ºä¾‹

#### 1. é…ç½®æ¸ é“è¿‡æ»¤é”®

```typescript
// è®¾ç½®æ¸ é“ä½¿ç”¨ branch å’Œ environment ä½œä¸ºè¿‡æ»¤å™¨
await db
  .update(channels)
  .set({
    manifestFilterKeys: ['branch', 'environment'],
  })
  .where(eq(channels.id, channelId));
```

#### 2. ä¸Šä¼ æ›´æ–°æ—¶æä¾›å…ƒæ•°æ®

```typescript
{
  metadata: {
    branch: "main",
    environment: "production",
    version: "1.0.0"
  }
}
```

#### 3. å“åº”å¤´ç¤ºä¾‹

```http
expo-manifest-filters: branch="main", environment="production"
```

### è¿‡æ»¤è§„åˆ™

æ ¹æ® Expo è§„èŒƒï¼Œå®¢æˆ·ç«¯ä¼šï¼š

1. å­˜å‚¨ `expo-manifest-filters` ç›´åˆ°è¢«æ–°å“åº”è¦†ç›–
2. è¿‡æ»¤æœ¬åœ°æ›´æ–°ï¼šå…ƒæ•°æ®å¿…é¡»åŒ¹é…æˆ–ç¼ºå¤±è¿‡æ»¤å™¨ä¸­çš„å­—æ®µ
3. é€‰æ‹©æœ€æ–°çš„ç¬¦åˆæ¡ä»¶çš„æ›´æ–°

### ä½¿ç”¨åœºæ™¯

- **å¤šåˆ†æ”¯å¼€å‘**: `branch="dev"`, `branch="staging"`, `branch="main"`
- **å¤šç¯å¢ƒéƒ¨ç½²**: `environment="test"`, `environment="production"`
- **å‘å¸ƒæ¸ é“**: `releaseChannel="alpha"`, `releaseChannel="beta"`
- **åœ°åŸŸåˆ†ç»„**: `region="us-east"`, `region="eu-west"`

---

## 3. ğŸ” å®Œæ•´çš„ä»£ç ç­¾åæµç¨‹æµ‹è¯•

### åŠŸèƒ½è¯´æ˜

åˆ›å»ºäº†ç«¯åˆ°ç«¯çš„ä»£ç ç­¾åæµ‹è¯•ï¼Œè¦†ç›–å®Œæ•´çš„ç­¾åéªŒè¯æµç¨‹ã€‚

### æµ‹è¯•æ–‡ä»¶

```
src/modules/hot-update/__test__/api/04-signing/
â”œâ”€â”€ 00-setup.ts                 # åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ
â”œâ”€â”€ 01-set-signing-keys.ts      # è®¾ç½®ç­¾åå¯†é’¥
â”œâ”€â”€ 02-disable-signing.ts       # ç¦ç”¨ç­¾å
â”œâ”€â”€ 03-end-to-end-test.ts       # ğŸ†• å®Œæ•´æµç¨‹æµ‹è¯•
â””â”€â”€ 99-cleanup.ts               # æ¸…ç†æµ‹è¯•æ•°æ®
```

### æµ‹è¯•è¦†ç›–èŒƒå›´

#### æ­¥éª¤ 1: ç”Ÿæˆå¹¶è®¾ç½®ç­¾åå¯†é’¥

- âœ… ç”Ÿæˆ RSA 2048 å¯†é’¥å¯¹
- âœ… è°ƒç”¨ `channels.setSigningKeys` API
- âœ… éªŒè¯å…¬é’¥å­˜å‚¨å’Œæ£€ç´¢

#### æ­¥éª¤ 2: ä¸Šä¼ å¸¦ç­¾åçš„æ›´æ–°

- âœ… åˆ›å»ºæµ‹è¯• JavaScript bundle
- âœ… ä¸Šä¼ æ›´æ–°ï¼ˆå¸¦ metadataï¼‰
- âœ… éªŒè¯æ›´æ–°åˆ›å»ºæˆåŠŸ

#### æ­¥éª¤ 3: æ£€æŸ¥æ›´æ–°ï¼ˆè¯·æ±‚ç­¾åï¼‰

- âœ… æºå¸¦ `expo-expect-signature` è¯·æ±‚å¤´
- âœ… æ ¼å¼: `sig, keyid="root", alg="rsa-v1_5-sha256"`
- âœ… æœåŠ¡ç«¯è¯†åˆ«ç­¾åè¯·æ±‚

#### æ­¥éª¤ 4: éªŒè¯å“åº”å¤´

- âœ… æ£€æŸ¥ `expo-signature` å“åº”å¤´å­˜åœ¨
- âœ… è§£æ SFV å­—å…¸æ ¼å¼
- âœ… æå–ç­¾åæ•°æ® (`sig`, `keyid`, `alg`)

#### æ­¥éª¤ 5: ä½¿ç”¨å…¬é’¥éªŒè¯ç­¾å

- âœ… è·å– manifest JSON
- âœ… è°ƒç”¨ `verifyManifestSignatureAsync()`
- âœ… ç¡®è®¤ç­¾åæœ‰æ•ˆæ€§

#### æ­¥éª¤ 6: éªŒè¯ Manifest Filters

- âœ… æ£€æŸ¥ `expo-manifest-filters` å“åº”å¤´
- âœ… éªŒè¯ SFV æ ¼å¼
- âœ… ç¡®è®¤å…ƒæ•°æ®è¿‡æ»¤é€»è¾‘

#### æ­¥éª¤ 7: ç¦ç”¨ç­¾åæµ‹è¯•

- âœ… è°ƒç”¨ `channels.disableSigning`
- âœ… éªŒè¯ä¸å†è¿”å› `expo-signature` å¤´
- âœ… ç¡®è®¤ç­¾ååŠŸèƒ½æ­£ç¡®ç¦ç”¨

### è¿è¡Œæµ‹è¯•

```bash
# 1. å¯åŠ¨æœåŠ¡
bun run dev

# 2. åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒï¼ˆå¦‚æœå°šæœªè¿è¡Œï¼‰
bun run src/modules/hot-update/__test__/api/04-signing/00-setup.ts

# 3. è¿è¡Œå®Œæ•´æµ‹è¯•
bun run src/modules/hot-update/__test__/api/04-signing/03-end-to-end-test.ts

# 4. æ¸…ç†æµ‹è¯•æ•°æ®ï¼ˆå¯é€‰ï¼‰
bun run src/modules/hot-update/__test__/api/04-signing/99-cleanup.ts
```

### é¢„æœŸè¾“å‡º

```
===========================================================
ğŸ” ç­¾ååœºæ™¯ - å®Œæ•´ç«¯åˆ°ç«¯æµ‹è¯•
===========================================================

ğŸ“ æ­¥éª¤ 1: ç”Ÿæˆå¹¶è®¾ç½®ç­¾åå¯†é’¥
-----------------------------------------------------------
âœ… RSA 2048 å¯†é’¥å¯¹å·²ç”Ÿæˆ
âœ… ç­¾åå¯†é’¥å·²è®¾ç½®åˆ°æ¸ é“

ğŸ“ æ­¥éª¤ 2: ä¸Šä¼ æµ‹è¯•æ›´æ–°ï¼ˆåŒ…å«èµ„æºï¼‰
-----------------------------------------------------------
âœ… æµ‹è¯•æ›´æ–°å·²ä¸Šä¼ 

ğŸ“ æ­¥éª¤ 3: æ£€æŸ¥æ›´æ–°ï¼ˆè¯·æ±‚ç­¾åï¼‰
-----------------------------------------------------------
âœ… è¯·æ±‚å·²å‘é€

ğŸ“ æ­¥éª¤ 4: éªŒè¯å“åº”å¤´
-----------------------------------------------------------
âœ… expo-signature å“åº”å¤´å­˜åœ¨
âœ… ç­¾åæ•°æ®å·²è§£æ

ğŸ“ æ­¥éª¤ 5: ä½¿ç”¨å…¬é’¥éªŒè¯ç­¾å
-----------------------------------------------------------
âœ… ç­¾åéªŒè¯æˆåŠŸ

ğŸ“ æ­¥éª¤ 6: éªŒè¯ Manifest Filters
-----------------------------------------------------------
âœ… Manifest Filters å·²è®¾ç½®

ğŸ“ æ­¥éª¤ 7: ç¦ç”¨ç­¾åå¹¶æµ‹è¯•
-----------------------------------------------------------
âœ… ç­¾åå·²ç¦ç”¨
âœ… ç¦ç”¨ç­¾ååä¸å†è¿”å› expo-signature å¤´

===========================================================
ğŸ‰ ç«¯åˆ°ç«¯ç­¾åæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼
===========================================================
```

---

## ğŸ¯ åè®®ç¬¦åˆåº¦

### æ›´æ–°å‰ï¼ˆçº¦ 85%ï¼‰

- âœ… åŸºç¡€ Expo å“åº”å¤´
- âœ… Manifest ç»“æ„
- âœ… èµ„æºäºŒè¿›åˆ¶ä¸‹è½½
- âš ï¸ æ— å‹ç¼©æ”¯æŒ
- âš ï¸ manifest-filters ä¸ºç©º
- âš ï¸ ç­¾åæµ‹è¯•ä¸å®Œæ•´

### æ›´æ–°åï¼ˆçº¦ 98%ï¼‰

- âœ… åŸºç¡€ Expo å“åº”å¤´
- âœ… Manifest ç»“æ„
- âœ… èµ„æºäºŒè¿›åˆ¶ä¸‹è½½
- âœ… **Gzip å‹ç¼©æ”¯æŒ**
- âœ… **Manifest Filters ä¸šåŠ¡é€»è¾‘**
- âœ… **å®Œæ•´çš„ä»£ç ç­¾åæµ‹è¯•**
- âœ… **ç«¯åˆ°ç«¯æµç¨‹éªŒè¯**

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Expo Updates v1 è§„èŒƒ](<../../docs/02-Expoçƒ­æ›´æ–°åè®®è§„èŒƒ(ä¸­æ–‡).md>)
- [Expo SFV 0 è§„èŒƒ](https://docs.expo.dev/technical-specs/expo-sfv-0/)
- [ä»£ç ç­¾åæŒ‡å—](./04-signing/README.md)

---

## ğŸš€ ä¸‹ä¸€æ­¥è®¡åˆ’

### ä¼˜åŒ–é¡¹

1. **Brotli å‹ç¼©**: é›†æˆç¬¬ä¸‰æ–¹åº“æ”¯æŒ `br` ç¼–ç ï¼ˆå‹ç¼©ç‡æ¯” gzip æ›´é«˜ï¼‰
2. **å‹ç¼©ç¼“å­˜**: é¢„å‹ç¼©å¸¸ç”¨èµ„æºï¼Œå‡å°‘ CPU å¼€é”€
3. **Filters é…ç½® UI**: åœ¨ç®¡ç†åå°æä¾›å¯è§†åŒ–çš„ manifest filters é…ç½®

### æ‰©å±•åŠŸèƒ½

1. **å¤šç­¾åå¯†é’¥**: æ”¯æŒå¯†é’¥è½®è½¬å’Œå¤šç‰ˆæœ¬ç­¾å
2. **CDN é›†æˆ**: èµ„æºä¸‹è½½é€šè¿‡ CDN åŠ é€Ÿ
3. **ç›‘æ§æŒ‡æ ‡**: ç»Ÿè®¡å‹ç¼©ç‡ã€ç­¾åéªŒè¯æˆåŠŸç‡ç­‰

---

## ğŸ› å·²çŸ¥é—®é¢˜

1. **Brotli æ”¯æŒ**: å½“å‰ Bun ä¸æä¾›åŸç”Ÿ brotli APIï¼Œéœ€è¦é›†æˆ `brotli-wasm` æˆ–ç±»ä¼¼åº“
2. **å¤§æ–‡ä»¶å‹ç¼©**: è¶…å¤§æ–‡ä»¶ï¼ˆ>10MBï¼‰å¯èƒ½å¯¼è‡´ CPU å³°å€¼ï¼Œå»ºè®®é¢„å‹ç¼©
3. **ç­¾åæ€§èƒ½**: RSA ç­¾åæœ‰ä¸€å®šæ€§èƒ½å¼€é”€ï¼Œé«˜å¹¶å‘åœºæ™¯ä¸‹éœ€è¦ç¼“å­˜ç­–ç•¥

---

## ğŸ’¡ æœ€ä½³å®è·µ

### Manifest Filters é…ç½®å»ºè®®

```typescript
// æ¨èé…ç½®
manifestFilterKeys: ['branch', 'environment'];

// ä¸æ¨èï¼šè¿‡å¤šå­—æ®µä¼šå¯¼è‡´è¿‡æ»¤å™¨è¿‡äºä¸¥æ ¼
manifestFilterKeys: [
  'branch',
  'environment',
  'version',
  'build',
  'user',
];
```

### å‹ç¼©ç­–ç•¥å»ºè®®

```typescript
// é€‚åˆå‹ç¼©çš„èµ„æºç±»å‹
const COMPRESSIBLE_TYPES = [
  'application/javascript',
  'application/json',
  'text/html',
  'text/css',
  'text/xml',
];

// ä¸éœ€è¦å‹ç¼©çš„èµ„æºç±»å‹ï¼ˆå·²å‹ç¼©ï¼‰
const NON_COMPRESSIBLE_TYPES = [
  'image/png',
  'image/jpeg',
  'image/webp',
  'video/*',
];
```

### ç­¾åå®‰å…¨å»ºè®®

1. **å¯†é’¥å­˜å‚¨**: ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ HSM æˆ–å¯†é’¥ç®¡ç†æœåŠ¡
2. **å¯†é’¥è½®è½¬**: å®šæœŸæ›´æ¢ç­¾åå¯†é’¥
3. **æƒé™æ§åˆ¶**: ä¸¥æ ¼é™åˆ¶å¯†é’¥è®¿é—®æƒé™
4. **å®¡è®¡æ—¥å¿—**: è®°å½•æ‰€æœ‰ç­¾åæ“ä½œ

---

**å®ç°æ—¥æœŸ**: 2025 å¹´ 12 æœˆ 19 æ—¥  
**ç¬¦åˆåè®®**: Expo Updates v1  
**æµ‹è¯•è¦†ç›–ç‡**: 98%
