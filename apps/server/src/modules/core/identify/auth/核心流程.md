## 核心流程

### 1. 用户登录流程 (login)

```mermaid
sequenceDiagram
    participant C as Client
    participant R as Router
    participant LS as LoginService
    participant US as UserService
    participant DS as DeviceService
    participant SS as SessionService
    participant RTS as RefreshTokenService
    participant Redis as Redis
    participant PG as PostgreSQL

    C->>R: POST /auth.login {username, password, deviceFingerprint?}
    R->>LS: login(db, redis, input)

    %% 1. 验证用户凭证
    LS->>US: getUserByUsername(db, username)
    US->>PG: SELECT FROM users
    PG-->>US: user | null
    US-->>LS: user

    alt 用户不存在
        LS-->>R: {success: false, errorCode: INVALID_CREDENTIALS}
    end

    LS->>LS: verifyPassword(password, passwordHash)

    alt 密码错误
        LS-->>R: {success: false, errorCode: INVALID_CREDENTIALS}
    end

    %% 2. 检查用户状态
    alt status = pending_verification
        LS-->>R: {success: false, errorCode: USER_NOT_ACTIVE}
    else status = disabled
        LS-->>R: {success: false, errorCode: USER_NOT_ACTIVE}
    else status = locked
        LS-->>R: {success: false, errorCode: USER_LOCKED}
    end

    %% 3. 处理设备（可选）
    opt deviceFingerprint 存在
        LS->>DS: upsertDevice(db, userId, deviceInfo)
        DS->>PG: INSERT/UPDATE user_devices
        PG-->>DS: device
        DS-->>LS: device.id
    end

    %% 4. 获取用户角色
    LS->>R: getUserRoles(db, userId)
    R->>PG: SELECT roles FROM user_role_mappings JOIN roles
    PG-->>R: roles[]
    R-->>LS: roles[]

    %% 5. 创建会话
    LS->>SS: createSession(db, sessionData)
    SS->>PG: INSERT INTO user_sessions
    PG-->>SS: session
    SS-->>LS: session

    %% 6. 缓存 Session 到 Redis
    LS->>Redis: SET auth:session:{sessionId}

    %% 7. 记录用户活跃会话
    LS->>Redis: SADD auth:user:sessions:{userId} {sessionId}

    %% 8. 生成 Access Token
    LS->>LS: signToken(authUser, {sessionId})

    %% 9. 生成 Refresh Token
    LS->>RTS: createInitialRefreshToken(db, {sessionId})
    RTS->>PG: INSERT INTO user_refresh_tokens
    PG-->>RTS: {rawToken, record}
    RTS-->>LS: refreshToken

    LS-->>R: {success: true, accessToken, refreshToken, user}
    R-->>C: {accessToken, refreshToken, user}
```

---

### 2. Token 刷新流程 (refresh)

```mermaid
sequenceDiagram
    participant C as Client
    participant R as Router
    participant RS as RefreshService
    participant RTS as RefreshTokenService
    participant SS as SessionService
    participant US as UserService
    participant PG as PostgreSQL

    C->>R: POST /auth.refresh {refreshToken}
    R->>RS: refreshTokens(db, redis, rawToken)

    %% 1. 验证 RT
    RS->>RTS: validateRefreshToken(db, rawToken)
    RTS->>RTS: hashToken(rawToken)
    RTS->>PG: SELECT FROM user_refresh_tokens WHERE tokenHash
    PG-->>RTS: token | null

    alt Token 不存在
        RTS-->>RS: {valid: false, reason: TOKEN_NOT_FOUND}
        RS-->>R: {success: false, errorCode: UNAUTHORIZED}
    else Token 已过期
        RTS-->>RS: {valid: false, reason: TOKEN_EXPIRED}
        RS-->>R: {success: false, errorCode: TOKEN_EXPIRED}
    else Token 已撤销
        RTS-->>RS: {valid: false, reason: TOKEN_REVOKED}
        RS-->>R: {success: false, errorCode: TOKEN_REVOKED}
    else Token 已使用（重放攻击！）
        RTS->>RTS: revokeTokenFamily(db, family)
        RTS->>PG: UPDATE user_refresh_tokens SET isRevoked WHERE family
        RTS-->>RS: {valid: false, reason: REPLAY_DETECTED}
        RS-->>R: {success: false, errorCode: REPLAY_DETECTED}
    end

    RTS-->>RS: {valid: true, token}

    %% 2. 验证关联会话
    RS->>SS: validateSession(db, sessionId)
    SS->>PG: SELECT FROM user_sessions WHERE sessionId

    alt 会话无效
        RS->>RTS: revokeTokenFamily(db, family)
        RS-->>R: {success: false, errorCode: SESSION_EXPIRED}
    end

    %% 3. 获取用户信息
    RS->>US: getUserById(db, userId)
    US->>PG: SELECT FROM users

    alt 用户不存在或状态异常
        RS->>SS: revokeSession(db, sessionId)
        RS->>RTS: revokeTokenFamily(db, family)
        RS-->>R: {success: false, errorCode: USER_NOT_ACTIVE}
    end

    %% 4. 标记当前 RT 为已使用
    RS->>RTS: markTokenAsUsed(db, tokenId)
    RTS->>PG: UPDATE user_refresh_tokens SET isUsed = true

    %% 5. 轮换生成新的 RT
    RS->>RTS: rotateRefreshToken(db, currentToken, {ipAddress})
    RTS->>PG: INSERT INTO user_refresh_tokens (family, generation+1)
    PG-->>RTS: newToken
    RTS-->>RS: {rawToken: newRefreshToken}

    %% 6. 更新会话活跃时间
    RS->>SS: updateSessionActivity(db, sessionId)
    SS->>PG: UPDATE user_sessions SET lastActivityAt

    %% 7. 生成新的 AT
    RS->>RS: signToken(authUser, {sessionId})

    RS-->>R: {success: true, accessToken, refreshToken, user}
    R-->>C: {accessToken, refreshToken, user}
```

---

### 3. 单会话登出流程 (logout)

```mermaid
sequenceDiagram
    participant C as Client
    participant R as Router
    participant LOS as LogoutService
    participant SS as SessionService
    participant RTS as RefreshTokenService
    participant Redis as Redis
    participant PG as PostgreSQL

    C->>R: POST /auth.logout (携带 JWT)
    R->>R: 验证 JWT，提取 sessionId, jti
    R->>LOS: logoutSession(db, redis, sessionId, jti)

    %% 1. 获取会话信息
    LOS->>SS: getSessionBySessionId(db, sessionId)
    SS->>PG: SELECT FROM user_sessions
    PG-->>SS: session
    SS-->>LOS: session (含 userId)

    %% 2. 撤销会话
    LOS->>SS: revokeSession(db, sessionId, USER_LOGOUT)
    SS->>PG: UPDATE user_sessions SET isRevoked = true

    %% 3. 撤销所有 RT
    LOS->>RTS: revokeAllSessionTokens(db, sessionId, USER_LOGOUT)
    RTS->>PG: UPDATE user_refresh_tokens SET isRevoked WHERE sessionId
    PG-->>RTS: count
    RTS-->>LOS: revokedTokens

    %% 4. 将当前 AT 加入黑名单
    LOS->>Redis: SETEX auth:at:blacklist:{jti} 900 "1"

    %% 5. 使 Session 缓存失效
    LOS->>Redis: DEL auth:session:{sessionId}

    %% 6. 从用户活跃会话列表移除
    LOS->>Redis: SREM auth:user:sessions:{userId} {sessionId}

    LOS-->>R: {success: true, revokedSessions: 1, revokedTokens}
    R-->>C: {success: true}
```

---

### 4. 全设备登出流程 (logoutAll)

```mermaid
sequenceDiagram
    participant C as Client
    participant R as Router
    participant LOS as LogoutService
    participant SS as SessionService
    participant RTS as RefreshTokenService
    participant Redis as Redis
    participant PG as PostgreSQL

    C->>R: POST /auth.logoutAll (携带 JWT)
    R->>R: 验证 JWT，提取 userId, jti
    R->>LOS: logoutAllSessions(db, redis, userId, jti)

    %% 1. 获取所有活跃会话
    LOS->>SS: getActiveSessionsByUserId(db, userId)
    SS->>PG: SELECT FROM user_sessions WHERE userId AND NOT revoked
    PG-->>SS: sessions[]
    SS-->>LOS: sessions[]

    %% 2. 撤销所有会话
    LOS->>SS: revokeAllUserSessions(db, userId, USER_LOGOUT)
    SS->>PG: UPDATE user_sessions SET isRevoked WHERE userId
    PG-->>SS: count
    SS-->>LOS: revokedSessions

    %% 3. 撤销所有会话的 RT
    loop 每个会话
        LOS->>RTS: revokeAllSessionTokens(db, sessionId)
        RTS->>PG: UPDATE user_refresh_tokens SET isRevoked
        LOS->>Redis: DEL auth:session:{sessionId}
    end

    %% 4. 将当前 AT 加入黑名单
    LOS->>Redis: SETEX auth:at:blacklist:{jti} 900 "1"

    %% 5. 清空用户活跃会话列表
    LOS->>Redis: DEL auth:user:sessions:{userId}

    LOS-->>R: {success: true, revokedSessions, revokedTokens}
    R-->>C: {success: true}
```

---

## Redis 键设计

| Key 模式                      | 数据类型      | TTL                      | 用途                               |
| ----------------------------- | ------------- | ------------------------ | ---------------------------------- |
| `auth:at:blacklist:{jti}`     | String        | 15min (AT 过期时间)      | AT 黑名单，用于主动失效已发放的 AT |
| `auth:session:{sessionId}`    | String (JSON) | 30 天 (Session 过期时间) | Session 缓存，加速会话验证         |
| `auth:user:sessions:{userId}` | Set           | 无 (手动管理)            | 用户活跃会话列表，快速查询在线设备 |

### Session 缓存数据结构

```typescript
interface SessionCacheData {
  userId: string;
  sessionId: string;
  deviceId?: string;
  isRevoked: boolean;
  expiresAt: number; // timestamp
}
```

---

## 路由设计

### 公开接口 (publicProcedure)

| 路由           | 方法     | 描述       | 输入                                                                 |
| -------------- | -------- | ---------- | -------------------------------------------------------------------- |
| `auth.login`   | mutation | 用户登录   | `{username, password, deviceFingerprint?, deviceName?, deviceType?}` |
| `auth.refresh` | mutation | 刷新 Token | `{refreshToken}`                                                     |

### 需认证接口 (protectedProcedure)

| 路由                 | 方法     | 描述             | 输入          |
| -------------------- | -------- | ---------------- | ------------- |
| `auth.me`            | query    | 获取当前用户信息 | -             |
| `auth.logout`        | mutation | 单设备登出       | -             |
| `auth.logoutAll`     | mutation | 全设备登出       | -             |
| `auth.sessions`      | query    | 获取所有活跃会话 | -             |
| `auth.revokeSession` | mutation | 撤销指定会话     | `{sessionId}` |
| `auth.devices`       | query    | 获取所有设备     | -             |
| `auth.trustDevice`   | mutation | 设置设备为可信   | `{deviceId}`  |
| `auth.untrustDevice` | mutation | 取消设备信任     | `{deviceId}`  |
| `auth.removeDevice`  | mutation | 删除设备         | `{deviceId}`  |

---

## Token 安全机制

### Access Token (AT)

- **类型**: JWT
- **有效期**: 15 分钟
- **存储**: 客户端 (内存/localStorage)
- **验证**: 无状态验证 + Redis 黑名单检查
- **失效**: 自然过期 或 加入黑名单

### Refresh Token (RT)

- **类型**: 随机字符串 (base64url, 32 字节)
- **有效期**: 7 天
- **存储**: PostgreSQL (仅存哈希值)
- **安全机制**:
  - **Token 轮换**: 每次刷新生成新 RT，旧 RT 立即标记为已使用
  - **家族追踪**: 同一会话的所有 RT 共享 `family` 标识
  - **重放检测**: 已使用的 RT 被重复使用时，撤销整个家族

### 重放攻击防护

```mermaid
flowchart TD
    A[客户端使用 RT 刷新] --> B{RT 是否已使用?}
    B -->|否| C[标记为已使用]
    C --> D[生成新 RT]
    D --> E[返回新 Token 对]

    B -->|是| F[检测到重放攻击!]
    F --> G[撤销整个 Token 家族]
    G --> H[撤销关联会话]
    H --> I[返回安全错误]
```

---

## 数据模型

### user_sessions (用户会话表)

| 字段           | 类型         | 说明                   |
| -------------- | ------------ | ---------------------- |
| id             | UUID         | 主键                   |
| userId         | UUID         | 用户 ID                |
| sessionId      | VARCHAR(255) | 会话唯一标识 (关联 RT) |
| ipAddress      | VARCHAR(50)  | 登录 IP                |
| userAgent      | TEXT         | 浏览器 UA              |
| deviceId       | UUID         | 设备 ID (可选)         |
| isRevoked      | BOOLEAN      | 是否已撤销             |
| revokedAt      | TIMESTAMP    | 撤销时间               |
| revokeReason   | VARCHAR(100) | 撤销原因               |
| lastActivityAt | TIMESTAMP    | 最后活跃时间           |
| expiresAt      | TIMESTAMP    | 过期时间 (30 天)       |

### user_refresh_tokens (刷新令牌表)

| 字段          | 类型         | 说明              |
| ------------- | ------------ | ----------------- |
| id            | UUID         | 主键              |
| sessionId     | VARCHAR(255) | 关联会话 ID       |
| tokenHash     | VARCHAR(255) | Token SHA256 哈希 |
| family        | VARCHAR(255) | Token 家族标识    |
| generation    | INTEGER      | 代数 (轮换次数)   |
| parentTokenId | UUID         | 父 Token ID       |
| isUsed        | BOOLEAN      | 是否已使用        |
| usedAt        | TIMESTAMP    | 使用时间          |
| isRevoked     | BOOLEAN      | 是否已撤销        |
| expiresAt     | TIMESTAMP    | 过期时间 (7 天)   |

### user_devices (用户设备表)

| 字段              | 类型         | 说明         |
| ----------------- | ------------ | ------------ |
| id                | UUID         | 主键         |
| userId            | UUID         | 用户 ID      |
| deviceFingerprint | VARCHAR(255) | 设备指纹     |
| deviceName        | VARCHAR(255) | 设备名称     |
| deviceType        | VARCHAR(50)  | 设备类型     |
| isTrusted         | BOOLEAN      | 是否可信     |
| isDisabled        | BOOLEAN      | 是否禁用     |
| lastActiveAt      | TIMESTAMP    | 最后活跃时间 |

---

## 错误代码

| 代码                     | 常量                | 说明               |
| ------------------------ | ------------------- | ------------------ |
| AUTH_INVALID_CREDENTIALS | INVALID_CREDENTIALS | 用户名或密码错误   |
| AUTH_USER_NOT_ACTIVE     | USER_NOT_ACTIVE     | 用户未激活或已禁用 |
| AUTH_USER_LOCKED         | USER_LOCKED         | 用户已锁定         |
| AUTH_SESSION_EXPIRED     | SESSION_EXPIRED     | 会话已过期         |
| AUTH_SESSION_REVOKED     | SESSION_REVOKED     | 会话已撤销         |
| AUTH_TOKEN_EXPIRED       | TOKEN_EXPIRED       | Token 已过期       |
| AUTH_TOKEN_REVOKED       | TOKEN_REVOKED       | Token 已撤销       |
| AUTH_TOKEN_USED          | TOKEN_USED          | Token 已使用       |
| AUTH_REPLAY_DETECTED     | REPLAY_DETECTED     | 检测到重放攻击     |
| AUTH_UNAUTHORIZED        | UNAUTHORIZED        | 未授权             |

---

## 时间配置

| 配置项                  | 值          | 说明                 |
| ----------------------- | ----------- | -------------------- |
| AT_EXPIRES_IN_SECONDS   | 900 (15min) | Access Token 有效期  |
| RT_EXPIRES_IN_DAYS      | 7           | Refresh Token 有效期 |
| SESSION_EXPIRES_IN_DAYS | 30          | 会话有效期           |
