# React Native 热更新（Hot Update）原理

## 1. 什么是热更新？

热更新（Hot Update / Over-The-Air Update，简称 OTA）是一种**无需通过应用商店发布新版本**，直接向用户推送应用更新的技术。用户无需重新下载整个 App，只需下载更新的 JavaScript Bundle 和静态资源即可完成应用升级。

### 1.1 为什么需要热更新？

| 痛点 | 热更新的解决方案 |
|------|-----------------|
| App Store / Google Play 审核周期长（1-7天） | 即时推送更新，分钟级生效 |
| 紧急 Bug 修复需要重新发版 | 快速修复线上问题 |
| 用户需手动更新 App | 静默更新，用户无感知 |
| A/B 测试需要多次发版 | 灵活部署不同版本 |
| 版本碎片化问题 | 强制更新统一版本 |

### 1.2 热更新 vs 传统更新

```
┌─────────────────────────────────────────────────────────────────┐
│                      传统更新流程                                 │
├─────────────────────────────────────────────────────────────────┤
│  开发 → 打包 → 提交商店 → 审核(1-7天) → 发布 → 用户手动更新        │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      热更新流程                                   │
├─────────────────────────────────────────────────────────────────┤
│  开发 → 打包 Bundle → 推送到服务器 → App 自动下载 → 即时生效       │
└─────────────────────────────────────────────────────────────────┘
```

## 2. React Native 热更新的技术基础

### 2.1 React Native 的架构特点

React Native 应用由两部分组成：

```
┌─────────────────────────────────────────────────────────────────┐
│                     React Native App                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│   ┌───────────────────────┐      ┌───────────────────────────┐   │
│   │    Native 层 (原生)     │      │    JavaScript 层          │   │
│   ├───────────────────────┤      ├───────────────────────────┤   │
│   │ • 原生 UI 组件          │      │ • 业务逻辑                 │   │
│   │ • 原生模块 (相机等)      │      │ • UI 组件代码              │   │
│   │ • 桥接代码              │      │ • 静态资源 (图片等)         │   │
│   │ • 第三方原生 SDK        │      │ • 打包成 JS Bundle         │   │
│   └───────────────────────┘      └───────────────────────────┘   │
│          ↓ 编译为二进制                   ↓ 可动态下载             │
│          不可热更新 ❌                    可热更新 ✅              │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 JS Bundle 是什么？

JS Bundle 是 React Native 应用中所有 JavaScript 代码和静态资源打包后的产物：

```bash
# 生成 Bundle 命令
npx react-native bundle \
  --platform ios \
  --dev false \
  --entry-file index.js \
  --bundle-output ./build/main.jsbundle \
  --assets-dest ./build
```

生成的文件结构：
```
build/
├── main.jsbundle          # 打包后的 JS 代码
├── main.jsbundle.map      # Source Map (用于调试)
└── assets/                # 静态资源文件
    ├── images/
    │   ├── logo.png
    │   └── icon.png
    └── fonts/
```

### 2.3 Bundle 加载机制

React Native 应用启动时，会加载 JS Bundle：

```
┌─────────────────────────────────────────────────────────────────┐
│                       App 启动流程                               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
            ┌─────────────────────────────────┐
            │    原生层初始化 React Native     │
            └─────────────────────────────────┘
                              │
                              ▼
            ┌─────────────────────────────────┐
            │      获取 JS Bundle 路径         │
            │   (可以是本地或远程路径)          │
            └─────────────────────────────────┘
                              │
                              ▼
            ┌─────────────────────────────────┐
            │   加载并执行 JS Bundle           │
            └─────────────────────────────────┘
                              │
                              ▼
            ┌─────────────────────────────────┐
            │        渲染 React 组件           │
            └─────────────────────────────────┘
```

**关键代码 - iOS (AppDelegate.mm)：**
```objective-c
- (NSURL *)bundleURL {
#if DEBUG
  // 开发模式：从 Metro 服务器加载
  return [[RCTBundleURLProvider sharedSettings] 
    jsBundleURLForBundleRoot:@"index"];
#else
  // 生产模式：从本地文件加载
  // 热更新的核心：替换这个路径
  return [[NSBundle mainBundle] 
    URLForResource:@"main" withExtension:@"jsbundle"];
#endif
}
```

**关键代码 - Android (MainApplication.kt)：**
```kotlin
override fun getJSBundleFile(): String? {
    // 热更新的核心：返回更新后的 Bundle 路径
    return CodePush.getJSBundleFile()
}
```

## 3. 热更新的工作原理

### 3.1 核心流程

```
┌──────────────────────────────────────────────────────────────────────────┐
│                          热更新完整流程                                   │
└──────────────────────────────────────────────────────────────────────────┘

  ┌─────────┐                                          ┌─────────────────┐
  │  开发者  │                                          │   热更新服务器   │
  └────┬────┘                                          └────────┬────────┘
       │                                                        │
       │ 1. 打包新版 Bundle                                      │
       │ ──────────────────────────────────────────────────────▶│
       │                                                        │
       │ 2. 上传到服务器                                         │
       │ ──────────────────────────────────────────────────────▶│
       │                                                        │
       │                                                        │
  ┌────┴────┐                                          ┌────────┴────────┐
  │  App 端  │◀─────────── 3. 检查更新 ─────────────────▶│   热更新服务器   │
  └────┬────┘                                          └────────┬────────┘
       │                                                        │
       │◀──────────────── 4. 返回更新信息 ──────────────────────│
       │  (版本号、下载地址、是否强制等)                          │
       │                                                        │
       │──────────────── 5. 下载更新包 ─────────────────────────▶│
       │                                                        │
       │◀──────────────── 6. 返回 Bundle 文件 ──────────────────│
       │                                                        │
       ▼                                                        
  ┌─────────┐
  │  App 端  │ 7. 解压并保存 Bundle
  └────┬────┘ 8. 重启应用加载新 Bundle
       │
       ▼
  ┌─────────────┐
  │ 更新完成！    │
  └─────────────┘
```

### 3.2 更新包结构

热更新包通常是一个压缩文件，包含：

```
update-package.zip
├── bundle/
│   ├── main.jsbundle           # JavaScript 代码
│   └── main.jsbundle.map       # Source Map (可选)
├── assets/                     # 静态资源
│   ├── images/
│   └── fonts/
└── metadata.json               # 元数据
    {
      "version": "1.0.1",
      "packageHash": "abc123...",
      "isMandatory": false,
      "description": "Bug 修复",
      "targetBinaryVersion": "1.0.0"
    }
```

### 3.3 增量更新 vs 全量更新

| 更新方式 | 描述 | 优点 | 缺点 |
|---------|------|------|------|
| 全量更新 | 每次下载完整的 Bundle | 简单可靠 | 包体积大，流量消耗多 |
| 增量更新 | 只下载变化的部分 (diff) | 包体积小，下载快 | 实现复杂，需要差分算法 |

```
全量更新：
v1.0.0 Bundle (5MB) ──────────────────▶ v1.0.1 Bundle (5MB)
                        下载 5MB

增量更新：
v1.0.0 Bundle (5MB) ──────────────────▶ v1.0.1 Bundle (5MB)
                        下载 Diff (500KB)
                        本地合并
```

## 4. 热更新的限制

### 4.1 无法热更新的内容

| 类型 | 能否热更新 | 原因 |
|------|-----------|------|
| JavaScript 业务代码 | ✅ 可以 | 打包在 Bundle 中 |
| React 组件样式 | ✅ 可以 | 打包在 Bundle 中 |
| 图片/字体等资源 | ✅ 可以 | 作为 assets 一起更新 |
| 原生模块代码 | ❌ 不可以 | 编译在二进制中 |
| 新增原生依赖 | ❌ 不可以 | 需要重新编译 |
| App 图标/启动图 | ❌ 不可以 | 系统级资源 |
| 权限配置变更 | ❌ 不可以 | Info.plist/AndroidManifest |

### 4.2 版本兼容性

热更新的 Bundle 必须与 App 的原生版本兼容：

```
App 二进制版本 1.0.0
├── 可以热更新到 Bundle v1.0.1 ✅
├── 可以热更新到 Bundle v1.0.2 ✅
└── 不能热更新到 Bundle v1.1.0 ❌ (如果依赖新原生模块)

App 二进制版本 1.1.0
├── 可以热更新到 Bundle v1.1.0 ✅
└── 可以热更新到 Bundle v1.1.1 ✅
```

## 5. 安全性考虑

### 5.1 代码签名

为防止恶意代码注入，热更新应实现代码签名验证：

```
发布流程：
1. 打包 Bundle
2. 使用私钥对 Bundle 进行签名
3. 上传 Bundle + 签名到服务器

验证流程：
1. App 下载 Bundle + 签名
2. 使用内置公钥验证签名
3. 验证通过才加载 Bundle
```

### 5.2 HTTPS 传输

所有热更新请求必须通过 HTTPS：
- 防止中间人攻击
- 防止 Bundle 被篡改
- 保护用户数据安全

### 5.3 回滚机制

如果新版本有问题，需要能够回滚到上一版本：

```javascript
// 标记更新成功
codePush.notifyAppReady();

// 如果 App 崩溃且未调用 notifyAppReady
// 下次启动会自动回滚到上一版本
```

## 6. 主流热更新方案对比

| 方案 | 类型 | 优点 | 缺点 |
|------|------|------|------|
| CodePush (AppCenter) | 云服务 | 成熟稳定，文档完善 | 微软已停止维护 |
| Expo Updates | 云服务 | Expo 原生支持 | 仅限 Expo 项目 |
| 自建服务 | 私有化 | 完全可控，无限制 | 需要自行开发维护 |
| Pushy | 云服务 | 国内访问快 | 功能相对简单 |

## 7. 总结

热更新技术使 React Native 应用能够：

1. **快速迭代** - 绕过应用商店审核
2. **即时修复** - 分钟级修复线上 Bug
3. **灵活发布** - A/B 测试、灰度发布
4. **提升体验** - 静默更新，用户无感知

在下一章节，我们将深入了解 CodePush 的具体实现原理。
