# 热更新回滚工作流 - 验证回滚效果

## 为什么需要验证?

回滚操作虽然简单,但必须确认:
- ✅ 客户端确实收到了回滚版本
- ✅ 资源文件可以正常下载
- ✅ 回滚后的稳定性指标
- ✅ 用户体验是否恢复正常

## 验证清单

### 1. 服务端验证

#### 1.1 确认更新状态

\`\`\`bash
# 查看最新的启用更新
curl -s "http://192.168.8.114:6688/trpc/hotUpdate.manage.updates.latestEnabled?input=$(echo '{"channelId":"a1b2c3d4-e5f6-4a7b-8c9d-800000000001","runtimeVersion":"1.0.0"}' | jq -sRr @uri)" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq '.result.data | {id, description, isRollback, isEnabled, createdAt}'
\`\`\`

**预期结果**:
- 返回的 ID 应该是回滚后的版本
- `isEnabled` 应该为 `true`
- 如果使用策略二,`isRollback` 应该为 `true`

#### 1.2 检查问题版本状态

\`\`\`bash
# 查看问题版本是否被正确处理
PROBLEM_UPDATE_ID="9d46c64d-1b34-42c9-b65b-e472b4cbdaf0"

curl -s "http://192.168.8.114:6688/trpc/hotUpdate.manage.updates.byId?input=$(echo "{\"id\":\"$PROBLEM_UPDATE_ID\"}" | jq -sRr @uri)" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq '.result.data | {id, isEnabled, description}'
\`\`\`

**预期结果**:
- 如果使用策略一: `isEnabled` 应该为 `false`
- 如果使用策略二: 可以是 `true` 或 `false`(但不是最新的)

---

### 2. 客户端协议验证

#### 2.1 模拟客户端请求 Manifest

\`\`\`bash
curl -s "http://192.168.8.114:6688/manifests/prod_demo_app_channel_key_12345678" \
  -H "expo-protocol-version: 1" \
  -H "expo-platform: android" \
  -H "expo-runtime-version: 1.0.0" \
  -H "expo-api-version: 1" \
  -H "expo-expect-signature: 1" | jq '{id, createdAt, metadata}'
\`\`\`

**预期结果**:
\`\`\`json
{
  "id": "0c70dfc3-27a8-432c-ab35-7aea674b6035",
  "createdAt": "2025-12-19T16:09:43.564Z",
  "metadata": {
    "version": "1.0.0",
    "timestamp": "1766158951",
    "buildNumber": "2"
  }
}
\`\`\`

✅ **检查点**:
- ID 应该匹配回滚版本
- metadata 应该是期望的版本信息

#### 2.2 验证资源 URL

\`\`\`bash
# 提取资源 URL 并测试访问
curl -s "http://192.168.8.114:6688/manifests/prod_demo_app_channel_key_12345678" \
  -H "expo-protocol-version: 1" \
  -H "expo-platform: android" \
  -H "expo-runtime-version: 1.0.0" \
  -H "expo-api-version: 1" \
  -H "expo-expect-signature: 1" | jq -r '.launchAsset.url' | xargs -I {} curl -I {}
\`\`\`

**预期结果**:
\`\`\`
HTTP/1.1 200 OK
Content-Type: application/octet-stream
Content-Length: ...
\`\`\`

✅ 资源应该返回 `200 OK`

#### 2.3 测试多个资源

\`\`\`bash
# 随机测试 3 个资源的可访问性
curl -s "http://192.168.8.114:6688/manifests/prod_demo_app_channel_key_12345678" \
  -H "expo-protocol-version: 1" \
  -H "expo-platform: android" \
  -H "expo-runtime-version: 1.0.0" \
  -H "expo-api-version: 1" \
  -H "expo-expect-signature: 1" | jq -r '.assets[0:3][].url' | while read url; do
  echo "Testing: $url"
  curl -s -o /dev/null -w "Status: %{http_code}\n" "$url"
done
\`\`\`

**预期结果**:
\`\`\`
Testing: http://192.168.8.114:6688/assets/...
Status: 200
Testing: http://192.168.8.114:6688/assets/...
Status: 200
Testing: http://192.168.8.114:6688/assets/...
Status: 200
\`\`\`

---

### 3. 真实设备验证

#### 3.1 准备测试设备

- 安装与 runtimeVersion 匹配的 App
- 确保设备可以访问服务器
- 清空 App 缓存(可选)

#### 3.2 触发更新检查

在 App 中触发热更新检查:

\`\`\`typescript
// 在 App 代码中
import { checkForUpdateAsync } from 'expo-updates';

const checkUpdate = async () => {
  const update = await checkForUpdateAsync();
  console.log('有可用更新:', update.isAvailable);
  console.log('更新 ID:', update.manifest?.id);
};
\`\`\`

**预期行为**:
- 应该检测到有新更新
- 更新 ID 应该是回滚版本的 ID

#### 3.3 下载并应用更新

\`\`\`typescript
import { fetchUpdateAsync, reloadAsync } from 'expo-updates';

const downloadAndApply = async () => {
  const result = await fetchUpdateAsync();
  console.log('下载成功:', result.isNew);
  
  if (result.isNew) {
    await reloadAsync(); // 重启 App 应用更新
  }
};
\`\`\`

**预期行为**:
- 下载应该成功
- 重启后 App 应该使用回滚版本
- App 功能正常,没有崩溃

#### 3.4 验证当前版本

\`\`\`typescript
import * as Updates from 'expo-updates';

console.log('当前更新 ID:', Updates.updateId);
console.log('运行时版本:', Updates.runtimeVersion);
\`\`\`

---

### 4. 监控指标验证

#### 4.1 查看下载统计

\`\`\`bash
ROLLBACK_ID="0c70dfc3-27a8-432c-ab35-7aea674b6035"

# 定期查询下载次数
while true; do
  curl -s "http://192.168.8.114:6688/trpc/hotUpdate.manage.updates.byId?input=$(echo "{\"id\":\"$ROLLBACK_ID\"}" | jq -sRr @uri)" \
    -H "Authorization: Bearer $ACCESS_TOKEN" | jq '.result.data | {downloadCount, installCount}'
  sleep 10
done
\`\`\`

**预期结果**:
- `downloadCount` 应该逐渐增加
- `installCount` 应该在下载后增加

#### 4.2 使用统计 API

\`\`\`bash
# 查看更新统计
curl -s "http://192.168.8.114:6688/trpc/hotUpdate.statistics.byUpdate?input=$(echo "{\"updateId\":\"$ROLLBACK_ID\"}" | jq -sRr @uri)" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq '.result.data'
\`\`\`

#### 4.3 渠道历史统计

\`\`\`bash
# 查看渠道更新历史
curl -s "http://192.168.8.114:6688/trpc/hotUpdate.statistics.channelHistory?input=$(echo '{"channelId":"a1b2c3d4-e5f6-4a7b-8c9d-800000000001","limit":5}' | jq -sRr @uri)" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq '.result.data[] | {id: .id[0:8], description, downloadCount, isRollback}'
\`\`\`

---

## 完整验证脚本

\`\`\`bash
#!/bin/bash

# 配置
CHANNEL_ID="a1b2c3d4-e5f6-4a7b-8c9d-800000000001"
CHANNEL_KEY="prod_demo_app_channel_key_12345678"
RUNTIME_VERSION="1.0.0"
EXPECTED_ROLLBACK_ID="0c70dfc3-27a8-432c-ab35-7aea674b6035"

echo "🔍 开始验证回滚效果..."
echo ""

# 1. 服务端验证
echo "1️⃣ 服务端验证"
echo "─────────────────────────────────────"

LATEST=$(curl -s "http://192.168.8.114:6688/trpc/hotUpdate.manage.updates.latestEnabled?input=$(echo "{\"channelId\":\"$CHANNEL_ID\",\"runtimeVersion\":\"$RUNTIME_VERSION\"}" | jq -sRr @uri)" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq '.result.data')

LATEST_ID=$(echo $LATEST | jq -r '.id')
IS_ROLLBACK=$(echo $LATEST | jq -r '.isRollback')

if [ "$LATEST_ID" == "$EXPECTED_ROLLBACK_ID" ]; then
  echo "   ✅ 最新版本正确: $LATEST_ID"
else
  echo "   ❌ 最新版本错误: $LATEST_ID (期望: $EXPECTED_ROLLBACK_ID)"
fi

if [ "$IS_ROLLBACK" == "true" ]; then
  echo "   ✅ 标记为回滚版本"
else
  echo "   ⚠️  未标记为回滚版本"
fi

echo ""

# 2. 客户端协议验证
echo "2️⃣ 客户端协议验证"
echo "─────────────────────────────────────"

MANIFEST=$(curl -s "http://192.168.8.114:6688/manifests/$CHANNEL_KEY" \
  -H "expo-protocol-version: 1" \
  -H "expo-platform: android" \
  -H "expo-runtime-version: $RUNTIME_VERSION" \
  -H "expo-api-version: 1" \
  -H "expo-expect-signature: 1")

MANIFEST_ID=$(echo $MANIFEST | jq -r '.id')

if [ "$MANIFEST_ID" == "$EXPECTED_ROLLBACK_ID" ]; then
  echo "   ✅ Manifest ID 正确: $MANIFEST_ID"
else
  echo "   ❌ Manifest ID 错误: $MANIFEST_ID (期望: $EXPECTED_ROLLBACK_ID)"
fi

echo ""

# 3. 资源验证
echo "3️⃣ 资源可访问性验证"
echo "─────────────────────────────────────"

LAUNCH_URL=$(echo $MANIFEST | jq -r '.launchAsset.url')
LAUNCH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$LAUNCH_URL")

if [ "$LAUNCH_STATUS" == "200" ]; then
  echo "   ✅ 启动资源可访问: $LAUNCH_STATUS"
else
  echo "   ❌ 启动资源不可访问: $LAUNCH_STATUS"
fi

# 测试 3 个资源
ASSET_COUNT=0
SUCCESS_COUNT=0

echo $MANIFEST | jq -r '.assets[0:3][].url' | while read url; do
  status=$(curl -s -o /dev/null -w "%{http_code}" "$url")
  if [ "$status" == "200" ]; then
    echo "   ✅ 资源可访问"
    ((SUCCESS_COUNT++))
  else
    echo "   ❌ 资源不可访问: $status"
  fi
  ((ASSET_COUNT++))
done

echo ""

# 4. 统计验证
echo "4️⃣ 统计数据验证"
echo "─────────────────────────────────────"

STATS=$(curl -s "http://192.168.8.114:6688/trpc/hotUpdate.manage.updates.byId?input=$(echo "{\"id\":\"$EXPECTED_ROLLBACK_ID\"}" | jq -sRr @uri)" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq '.result.data | {downloadCount, installCount}')

echo "   下载次数: $(echo $STATS | jq -r '.downloadCount')"
echo "   安装次数: $(echo $STATS | jq -r '.installCount')"

echo ""

# 总结
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "📊 验证总结"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "回滚版本 ID: $EXPECTED_ROLLBACK_ID"
echo "验证时间: $(date '+%Y-%m-%d %H:%M:%S')"
echo ""

if [ "$LATEST_ID" == "$EXPECTED_ROLLBACK_ID" ] && [ "$MANIFEST_ID" == "$EXPECTED_ROLLBACK_ID" ] && [ "$LAUNCH_STATUS" == "200" ]; then
  echo "✅ 回滚验证通过!"
  echo ""
  echo "下一步:"
  echo "  1. 持续监控下载/安装数量"
  echo "  2. 观察崩溃率和错误率"
  echo "  3. 收集用户反馈"
  echo "  4. 准备修复版本"
else
  echo "❌ 回滚验证失败!"
  echo ""
  echo "请检查:"
  echo "  1. 回滚操作是否正确执行"
  echo "  2. 服务器配置是否正确"
  echo "  3. 网络连接是否正常"
fi

echo ""
\`\`\`

## 验证检查点总结

| 检查项 | 预期结果 | 检查方法 |
|-------|---------|---------|
| 最新启用版本 | 回滚版本 ID | latestEnabled API |
| 问题版本状态 | 被禁用或非最新 | byId API |
| Manifest 返回 | 回滚版本 | /manifests 端点 |
| 资源可访问性 | HTTP 200 | curl -I |
| 真实设备下载 | 成功 | App 测试 |
| 真实设备应用 | 正常运行 | App 测试 |
| 下载统计增长 | 逐渐增加 | byId API |

## 常见验证失败原因

### 问题 1: Manifest 返回旧版本

**可能原因**:
- 回滚操作未成功
- 缓存问题

**解决方案**:
\`\`\`bash
# 重新执行回滚操作
# 清除浏览器/CDN 缓存
# 检查数据库记录
\`\`\`

### 问题 2: 资源 404

**可能原因**:
- 资源文件丢失
- URL 配置错误

**解决方案**:
\`\`\`bash
# 检查存储目录
ls -la storage/assets/

# 验证资源关联
curl -s "http://192.168.8.114:6688/trpc/hotUpdate.manage.updates.byId?input=..." \
  -H "Authorization: Bearer $ACCESS_TOKEN"
\`\`\`

### 问题 3: 真实设备不更新

**可能原因**:
- 设备缓存
- runtimeVersion 不匹配
- 网络问题

**解决方案**:
\`\`\`typescript
// 清除更新缓存
await Updates.clearUpdateCacheExperimentalAsync();

// 强制重新加载
await Updates.reloadAsync();
\`\`\`

## 监控时长建议

- **前 1 小时**: 每 5 分钟检查一次
- **前 24 小时**: 每 1 小时检查一次
- **后续**: 每天检查一次

## 回滚成功标准

- ✅ 服务端正确返回回滚版本
- ✅ 所有资源文件可访问
- ✅ 真实设备成功下载并应用
- ✅ 下载/安装数量正常增长
- ✅ 崩溃率降低到预期水平
- ✅ 用户反馈明显改善

## 下一步

回滚验证通过后:

1. **持续监控** - 观察关键指标至少 24 小时
2. **分析问题** - 深入分析问题版本的根本原因
3. **修复发布** - 准备并发布修复版本
4. **总结经验** - 记录回滚过程,改进流程
5. **更新文档** - 补充特殊情况和解决方案

## 参考资料

- [热更新工作流](../热更新工作流/README.md)
- [01-查看更新列表.md](01-查看更新列表.md)
- [02-禁用问题更新.md](02-禁用问题更新.md)
- [03-创建回滚版本.md](03-创建回滚版本.md)
