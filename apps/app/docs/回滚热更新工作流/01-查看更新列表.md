# 热更新回滚工作流 - 查看更新列表

## 目的

在进行回滚操作前,需要先了解当前渠道的所有更新版本,包括:
- 哪个版本是最新的
- 哪些版本是启用的
- 哪些版本是回滚版本
- 各版本的创建时间和描述

## 查询更新列表

### 准备工作

确保已经设置了 ACCESS_TOKEN 环境变量(参考 [../热更新工作流/01-登录认证.md](../热更新工作流/01-登录认证.md)):

\`\`\`bash
# 如果还没有 token,先登录
export ACCESS_TOKEN=$(curl -s -X POST "http://192.168.8.114:6688/trpc/core.identify.auth.login" \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"Admin@123456"}' | jq -r '.result.data.accessToken')
\`\`\`

### 查询命令

\`\`\`bash
# 查询指定渠道的所有更新
curl -s "http://192.168.8.114:6688/trpc/hotUpdate.manage.updates.listByChannel?input=$(echo '{"channelId":"a1b2c3d4-e5f6-4a7b-8c9d-800000000001"}' | jq -sRr @uri)" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq -r '.result.data[] | "\(.id[0:8])... | enabled=\(.isEnabled) | rollback=\(.isRollback) | \(.description // \"无描述\")"'
\`\`\`

**参数说明**:
- `channelId`: 要查询的渠道 ID (替换为你的实际渠道 ID)

### 示例输出

\`\`\`
0c70dfc3... | enabled=true | rollback=true | 回滚至: 测试更新 v1.0.0 - 2025-12-19_23:42:31
9d46c64d... | enabled=false | rollback=false | 测试更新 v1.0.1 - 修复资源URL
6c907a9f... | enabled=true | rollback=false | 测试更新 v1.0.1 - 修复资源URL
93df0bd7... | enabled=true | rollback=false | 测试更新 v1.0.1 - 修复资源URL
2343fbba... | enabled=true | rollback=false | 测试更新 v1.0.1 - 修复资源URL
1412d967... | enabled=true | rollback=false | 测试更新 v1.0.0 - 2025-12-19_23:42:31
\`\`\`

**解读**:
- 第一个 (0c70dfc3) 是最新的,并且是回滚版本
- 第二个 (9d46c64d) 被禁用了,说明它可能有问题
- 其余版本都是启用状态

## 查看详细信息

如果需要查看某个更新的完整信息:

\`\`\`bash
UPDATE_ID="0c70dfc3-27a8-432c-ab35-7aea674b6035"

curl -s "http://192.168.8.114:6688/trpc/hotUpdate.manage.updates.byId?input=$(echo "{\"id\":\"$UPDATE_ID\"}" | jq -sRr @uri)" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq '.result.data'
\`\`\`

### 完整响应示例

\`\`\`json
{
  "id": "0c70dfc3-27a8-432c-ab35-7aea674b6035",
  "channelId": "a1b2c3d4-e5f6-4a7b-8c9d-800000000001",
  "runtimeVersion": "1.0.0",
  "metadata": {
    "version": "1.0.0",
    "timestamp": "1766158951",
    "buildNumber": "2"
  },
  "extra": {},
  "description": "回滚至: 测试更新 v1.0.0 - 2025-12-19_23:42:31",
  "isEnabled": true,
  "isRollback": true,
  "rolloutPercentage": 100,
  "downloadCount": 0,
  "installCount": 0,
  "createdAt": "2025-12-19T16:09:43.564Z"
}
\`\`\`

## 按运行时版本查询

如果只想看特定 runtime version 的更新:

\`\`\`bash
curl -s "http://192.168.8.114:6688/trpc/hotUpdate.manage.updates.listByRuntimeVersion?input=$(echo '{"channelId":"a1b2c3d4-e5f6-4a7b-8c9d-800000000001","runtimeVersion":"1.0.0"}' | jq -sRr @uri)" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq -r '.result.data[] | "\(.id[0:8])... | \(.description)"'
\`\`\`

## 查询当前生效的更新

查看客户端当前会收到哪个更新:

\`\`\`bash
curl -s "http://192.168.8.114:6688/trpc/hotUpdate.manage.updates.latestEnabled?input=$(echo '{"channelId":"a1b2c3d4-e5f6-4a7b-8c9d-800000000001","runtimeVersion":"1.0.0"}' | jq -sRr @uri)" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq '.result.data | {id, description, isRollback, createdAt}'
\`\`\`

### 示例输出

\`\`\`json
{
  "id": "0c70dfc3-27a8-432c-ab35-7aea674b6035",
  "description": "回滚至: 测试更新 v1.0.0 - 2025-12-19_23:42:31",
  "isRollback": true,
  "createdAt": "2025-12-19T16:09:43.564Z"
}
\`\`\`

## 理解更新状态

### isEnabled (是否启用)

- `true`: 此更新可以被客户端下载
- `false`: 此更新被禁用,不会分发给客户端

### isRollback (是否回滚版本)

- `true`: 这是通过回滚API创建的版本
- `false`: 这是正常上传的版本

### 优先级规则

客户端请求更新时,系统返回:
1. **最新的启用版本** (按 createdAt 排序)
2. 匹配 runtimeVersion
3. rolloutPercentage 在范围内

## 实用技巧

### 1. 快速查看最近 5 个更新

\`\`\`bash
curl -s "http://192.168.8.114:6688/trpc/hotUpdate.manage.updates.listByChannel?input=$(echo '{"channelId":"a1b2c3d4-e5f6-4a7b-8c9d-800000000001"}' | jq -sRr @uri)" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq -r '.result.data[0:5] | .[] | {id: .id[0:8], enabled: .isEnabled, rollback: .isRollback, desc: .description}'
\`\`\`

### 2. 只看启用的更新

\`\`\`bash
curl -s "http://192.168.8.114:6688/trpc/hotUpdate.manage.updates.listByChannel?input=$(echo '{"channelId":"a1b2c3d4-e5f6-4a7b-8c9d-800000000001"}' | jq -sRr @uri)" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq -r '.result.data[] | select(.isEnabled == true) | "\(.id[0:8])... | \(.description)"'
\`\`\`

### 3. 找出所有回滚版本

\`\`\`bash
curl -s "http://192.168.8.114:6688/trpc/hotUpdate.manage.updates.listByChannel?input=$(echo '{"channelId":"a1b2c3d4-e5f6-4a7b-8c9d-800000000001"}' | jq -sRr @uri)" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq -r '.result.data[] | select(.isRollback == true) | "\(.id[0:8])... | \(.description)"'
\`\`\`

## 常见问题

### Q: 为什么看不到更新列表?

A: 检查:
1. ACCESS_TOKEN 是否有效
2. channelId 是否正确
3. 是否有权限访问该渠道

### Q: 怎么知道哪个版本有问题?

A: 观察:
1. isEnabled = false 的版本可能是被禁用的问题版本
2. 检查下载/安装数量是否异常
3. 查看创建时间,最近的更新更可能有问题

### Q: 列表太长怎么办?

A: 可以:
1. 使用 jq 过滤和分页
2. 只查询特定 runtime version
3. 只显示最近 N 个版本

## 下一步

查看更新列表后,选择回滚策略:

- **简单回滚**: [02-禁用问题更新.md](02-禁用问题更新.md)
- **显式回滚**: [03-创建回滚版本.md](03-创建回滚版本.md)
