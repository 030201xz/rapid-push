# 热更新回滚工作流 - 禁用问题更新(策略一)

## 适用场景

- ⚡ 需要**立即**回滚
- 🎯 上一个版本确认稳定
- 🔄 只需要回退一个版本
- ⏱️ 时间紧急,来不及详细分析

## 工作原理

禁用问题更新后,系统会自动返回**上一个启用的更新**给客户端。

### 示例场景

假设当前有以下更新(从新到旧):

| 版本 ID | 启用状态 | 描述 |
|---------|----------|------|
| v1.0.2 | ✅ 启用 | **← 当前生效** (有问题!) |
| v1.0.1 | ✅ 启用 | 稳定版本 |
| v1.0.0 | ✅ 启用 | 初始版本 |

禁用 v1.0.2 后:

| 版本 ID | 启用状态 | 描述 |
|---------|----------|------|
| v1.0.2 | ❌ 禁用 | (已回滚) |
| v1.0.1 | ✅ 启用 | **← 自动生效** |
| v1.0.0 | ✅ 启用 | 备用版本 |

## 操作步骤

### 1. 确定要禁用的更新 ID

参考 [01-查看更新列表.md](01-查看更新列表.md) 找到问题更新的 ID。

\`\`\`bash
# 查看最新的更新
curl -s "http://192.168.8.114:6688/trpc/hotUpdate.manage.updates.listByChannel?input=$(echo '{"channelId":"a1b2c3d4-e5f6-4a7b-8c9d-800000000001"}' | jq -sRr @uri)" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq '.result.data[0] | {id, description, isEnabled}'
\`\`\`

**输出示例**:
\`\`\`json
{
  "id": "9d46c64d-1b34-42c9-b65b-e472b4cbdaf0",
  "description": "测试更新 v1.0.1 - 修复资源URL",
  "isEnabled": true
}
\`\`\`

### 2. 禁用问题更新

\`\`\`bash
# 设置要禁用的更新 ID
PROBLEM_UPDATE_ID="9d46c64d-1b34-42c9-b65b-e472b4cbdaf0"

# 禁用该更新
curl -s -X POST "http://192.168.8.114:6688/trpc/hotUpdate.manage.updates.updateSettings" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d "{\"id\":\"$PROBLEM_UPDATE_ID\",\"isEnabled\":false}" | jq '.result.data | {id, isEnabled, description}'
\`\`\`

**成功响应**:
\`\`\`json
{
  "id": "9d46c64d-1b34-42c9-b65b-e472b4cbdaf0",
  "isEnabled": false,
  "description": "测试更新 v1.0.1 - 修复资源URL"
}
\`\`\`

### 3. 验证回滚生效

立即验证客户端现在会收到哪个更新:

\`\`\`bash
# 模拟客户端请求
curl -s "http://192.168.8.114:6688/manifests/prod_demo_app_channel_key_12345678" \
  -H "expo-protocol-version: 1" \
  -H "expo-platform: android" \
  -H "expo-runtime-version: 1.0.0" \
  -H "expo-api-version: 1" \
  -H "expo-expect-signature: 1" | jq '{id, createdAt, metadata}'
\`\`\`

**输出示例** (应该返回上一个版本):
\`\`\`json
{
  "id": "6c907a9f-575c-4e4d-bc3b-0af8fcd4ac0e",
  "createdAt": "2025-12-19T15:56:37.005Z",
  "metadata": {
    "version": "1.0.1",
    "timestamp": "1766159796",
    "buildNumber": "3"
  }
}
\`\`\`

✅ 如果 ID 不是被禁用的那个,说明回滚成功!

## 完整示例

### 一键禁用并验证

\`\`\`bash
#!/bin/bash

# 设置变量
CHANNEL_ID="a1b2c3d4-e5f6-4a7b-8c9d-800000000001"
CHANNEL_KEY="prod_demo_app_channel_key_12345678"
RUNTIME_VERSION="1.0.0"

# 1. 获取最新更新 ID
echo "📋 获取最新更新..."
LATEST_UPDATE=$(curl -s "http://192.168.8.114:6688/trpc/hotUpdate.manage.updates.listByChannel?input=$(echo "{\"channelId\":\"$CHANNEL_ID\"}" | jq -sRr @uri)" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq -r '.result.data[0]')

UPDATE_ID=$(echo $LATEST_UPDATE | jq -r '.id')
UPDATE_DESC=$(echo $LATEST_UPDATE | jq -r '.description')

echo "   ID: $UPDATE_ID"
echo "   描述: $UPDATE_DESC"
echo ""

# 2. 禁用该更新
echo "🚫 禁用更新..."
curl -s -X POST "http://192.168.8.114:6688/trpc/hotUpdate.manage.updates.updateSettings" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d "{\"id\":\"$UPDATE_ID\",\"isEnabled\":false}" > /dev/null

echo "   已禁用: $UPDATE_ID"
echo ""

# 3. 验证回滚
echo "✅ 验证回滚..."
CURRENT=$(curl -s "http://192.168.8.114:6688/manifests/$CHANNEL_KEY" \
  -H "expo-protocol-version: 1" \
  -H "expo-platform: android" \
  -H "expo-runtime-version: $RUNTIME_VERSION" \
  -H "expo-api-version: 1" \
  -H "expo-expect-signature: 1" | jq '{id, createdAt}')

echo "   当前生效版本:"
echo $CURRENT | jq '.'
echo ""

# 4. 检查是否成功
CURRENT_ID=$(echo $CURRENT | jq -r '.id')
if [ "$CURRENT_ID" != "$UPDATE_ID" ]; then
  echo "✅ 回滚成功! 当前版本: $CURRENT_ID"
else
  echo "❌ 回滚失败! 仍然是: $UPDATE_ID"
fi
\`\`\`

## 回滚后操作

### 1. 通知团队

\`\`\`
📢 紧急回滚通知

- 问题版本: v1.0.2 (9d46c64d...)
- 回滚原因: App崩溃率 > 10%
- 当前版本: v1.0.1 (6c907a9f...)
- 操作时间: 2025-12-19 16:00
- 操作人: @admin

请暂停发布新版本,等待进一步通知。
\`\`\`

### 2. 监控回滚效果

观察关键指标:
- 崩溃率是否下降
- 错误日志是否减少
- 用户反馈是否改善

### 3. 分析问题原因

- 下载问题版本的代码
- 复现问题
- 定位根本原因
- 准备修复方案

## 重新启用

如果发现禁用错了,可以重新启用:

\`\`\`bash
DISABLED_UPDATE_ID="9d46c64d-1b34-42c9-b65b-e472b4cbdaf0"

curl -s -X POST "http://192.168.8.114:6688/trpc/hotUpdate.manage.updates.updateSettings" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d "{\"id\":\"$DISABLED_UPDATE_ID\",\"isEnabled\":true}" | jq '.result.data.isEnabled'
\`\`\`

## 常见问题

### Q: 禁用后客户端多久能收到旧版本?

A: **立即生效**。下次客户端检查更新时就会收到上一个版本。

### Q: 已经下载了问题版本的用户怎么办?

A: 用户下次打开 App 并检查更新时,会下载回滚后的版本。

### Q: 可以禁用多个版本吗?

A: 可以。系统会返回最新的**启用**版本。

### Q: 禁用后能删除吗?

A: 不建议删除,保留用于分析问题。如果确实要删除:

\`\`\`bash
curl -s -X POST "http://192.168.8.114:6688/trpc/hotUpdate.manage.updates.delete" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d "{\"id\":\"$UPDATE_ID\"}"
\`\`\`

### Q: 禁用操作可以撤销吗?

A: 可以,重新启用即可(见"重新启用"章节)。

## 优缺点总结

### ✅ 优点

- 极快的响应速度
- 操作简单,一条命令
- 立即生效,无延迟
- 可以随时撤销

### ⚠️ 局限性

- 只能回到上一个版本
- 回滚历史不明显
- 无法跨越多个版本
- 难以追踪回滚记录

## 最佳实践

1. **快速决策** - 发现严重问题立即禁用
2. **先禁后查** - 先保护用户,再分析原因
3. **保留记录** - 不要删除,留作分析
4. **及时通知** - 通知团队和相关人员
5. **监控验证** - 确认回滚效果

## 对比策略二

如果需要:
- 回滚到更早的版本
- 明确标记回滚记录
- 保留问题版本供分析

请使用: [03-创建回滚版本.md](03-创建回滚版本.md)

## 下一步

回滚后请执行: [04-验证回滚.md](04-验证回滚.md)
