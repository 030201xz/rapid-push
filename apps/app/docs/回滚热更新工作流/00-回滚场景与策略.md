# 热更新回滚工作流 - 回滚场景与策略

## 什么是热更新回滚?

热更新回滚是指当线上更新出现严重问题时,快速恢复到之前稳定版本的操作。Rapid-S 提供了两种回滚策略:

## 回滚策略对比

### 策略一: 禁用问题更新(简单回滚)

**原理**: 将有问题的更新禁用,系统自动返回上一个启用的更新。

**优点**:
- ⚡ 操作简单,一条命令即可
- 🔄 自动回滚到上一个启用版本
- ⏱️ 立即生效,无需等待

**缺点**:
- ⚠️ 只能回滚到上一个版本
- 📊 回滚记录不明显
- 🔍 难以追踪回滚历史

**适用场景**:
- 最新更新刚发布就发现问题
- 需要立即回滚,不能等待
- 上一个版本确认是稳定的

### 策略二: 创建回滚版本(显式回滚)

**原理**: 基于指定的历史版本创建一个新的回滚更新。

**优点**:
- 📝 明确标记为回滚版本(isRollback = true)
- 🎯 可以回滚到任意历史版本
- 📊 回滚历史清晰可追踪
- 🔄 可以随时禁用回滚版本重新启用其他版本

**缺点**:
- ⏱️ 需要创建新版本,稍微慢一些
- 💾 会在数据库中创建新记录

**适用场景**:
- 需要回滚到较早的版本(跨越多个版本)
- 需要明确记录回滚操作
- 运营需要追踪回滚历史

## 回滚场景示例

### 场景 1: 严重 Bug 需要紧急回滚

**情况**: 
- 最新版本 v1.2.0 导致 App 崩溃
- 需要立即回滚到 v1.1.0

**推荐策略**: 禁用问题更新(策略一)

**理由**: 速度最快,立即生效

---

### 场景 2: 功能问题需要回到早期版本

**情况**:
- 最近 3 个版本都有相关的 Bug
- 需要回滚到 2 周前的稳定版本 v1.0.0

**推荐策略**: 创建回滚版本(策略二)

**理由**: 可以跨越多个版本回滚,且记录清晰

---

### 场景 3: A/B 测试失败

**情况**:
- 新版本在部分用户中表现不佳
- 需要回滚但保留新版本供后续修复

**推荐策略**: 创建回滚版本(策略二)

**理由**: 可以保留问题版本(禁用但不删除),方便后续分析

---

## 回滚决策树

\`\`\`mermaid
graph TD
    A[发现更新问题] --> B{问题严重程度}
    B -->|严重: 崩溃/数据丢失| C[立即回滚]
    B -->|一般: 功能异常| D[评估影响范围]
    
    C --> E{上一个版本是否稳定?}
    E -->|是| F[禁用问题更新<br/>策略一]
    E -->|否| G[需要更早版本]
    
    D --> H{影响用户数量}
    H -->|>50%| C
    H -->|<50%| I[监控并计划回滚]
    
    G --> J[创建回滚版本<br/>策略二]
    I --> J
    
    F --> K[验证回滚效果]
    J --> K
    
    K --> L{回滚成功?}
    L -->|是| M[监控稳定性]
    L -->|否| N[进一步降级]
\`\`\`

## 回滚后的操作清单

- [ ] 验证客户端收到正确的更新版本
- [ ] 监控回滚后的错误率和崩溃率
- [ ] 通知团队回滚操作
- [ ] 分析问题版本的原因
- [ ] 修复问题后重新发布
- [ ] 记录回滚事件到运营日志

## 注意事项

### ⚠️ 回滚前必须确认

1. **回滚目标版本的稳定性** - 确保目标版本确实是稳定的
2. **数据兼容性** - 新版本是否修改了数据结构?
3. **用户影响** - 有多少用户已经下载了问题版本?
4. **回滚时机** - 用户高峰期需谨慎操作

### 🔴 不要做的事情

- ❌ 不要删除问题版本(应该禁用,保留分析)
- ❌ 不要连续频繁回滚(会造成用户困惑)
- ❌ 不要回滚后立即再发新版(应等待稳定)
- ❌ 不要忽略回滚后的监控

### ✅ 最佳实践

- ✅ 在低峰期执行回滚操作
- ✅ 使用灰度发布避免大规模回滚
- ✅ 建立回滚预案和流程
- ✅ 回滚后及时通知用户(如有必要)

## 下一步

选择合适的回滚策略后,参考对应文档:

- **策略一**: [02-禁用问题更新.md](02-禁用问题更新.md)
- **策略二**: [03-创建回滚版本.md](03-创建回滚版本.md)

在开始之前,请先阅读: [01-查看更新列表.md](01-查看更新列表.md)
